# .gitlab-ci.yml
#
# Builds:
#  - on branch "development" (build artifacts only)
#  - on tags (release build with version taken from tag)
#
# Deploys:
#  - ONLY on tags (production deploy)
#
# Required CI/CD variables in GitLab (Settings -> CI/CD -> Variables):
#  - SSH_PRIVATE_KEY   (masked; ideally protected)
#  - DEPLOY_HOST       (e.g. "example.com")
#  - DEPLOY_USER       (e.g. "deploy")
#  - DEPLOY_PATH       (e.g. "/var/www/networksim")
#
# Optional:
#  - DEPLOY_PORT       (default 22)

stages:
  - build
  - deploy

default:
  image: node:20
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - .npm/
  before_script:
    - node -v
    - npm -v
    - npm ci --cache .npm --prefer-offline

build_dev:
  stage: build
  script:
    - |
      export VITE_APP_VERSION="$CI_COMMIT_SHORT_SHA"
      npm run build
  artifacts:
    expire_in: 31 days
    paths:
      - dist/
  rules:
    - if: '$CI_COMMIT_BRANCH == "development"'
    - when: never

build_release:
  stage: build
  image: node:20
  script:
    - npm ci
    - VERSION="${CI_COMMIT_TAG#v}"
    - npm version "$VERSION" --no-git-tag-version
    - export VITE_APP_VERSION="$VERSION"
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 year
  rules:
    - if: '$CI_COMMIT_TAG'
